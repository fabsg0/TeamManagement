@page "/"
@using BlazorDownloadFile
@inject IMemberService MemberService
@inject ToastService Toast
@inject IBlazorDownloadFileService BlazorDownloadFileService
@inject ILogger<Home> Logger

<PageTitle>Home</PageTitle>

<div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">Members</h2>
        <button type="button" class="btn btn-success" @onclick="() => _showCreatePopup = true">
            <i class="fa fa-plus-circle me-1"></i> Create Member
        </button>
        <button type="button" 
                disabled="@(_isExporting)"
                class="btn btn-secondary" 
                @onclick="ExportExcel">
            Export
        </button>
    </div>

    @if (_isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Loading members...</p>
        </div>
    }
    else if (!_members.Any())
    {
        <div class="alert alert-info text-center">
            No members found. Click "Create Member" to get started.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Birthdate</th>
                    <th>Status</th>
                    <th>Fee</th>
                    <th>City</th>
                    <th>Departments</th>
                    <th class="text-end">Actions</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var member in _members)
                {
                    <tr class="@(_selectedMember == member ? "table-active" : "")"
                        @onclick="() => _selectedMember = member">
                        <td>@member.FirstName</td>
                        <td>@member.LastName</td>
                        <td>@member.Birthdate</td>
                        <td>
                            <span class="badge bg-@GetStatusColor(member.Status)">@member.Status</span>
                        </td>
                        <td>€@member.MembershipFee</td>
                        <td>@member.City</td>
                        <td>
                            @foreach (var dept in member.Departments)
                            {
                                <span class="badge bg-secondary me-1">@dept.Name</span>
                            }
                        </td>
                        <td class="text-end">
                            <button type="button" class="btn btn-sm btn-warning me-1"
                                    @onclick="@(_ => OpenUpdatePopup(member))">
                                <i class="fa fa-pen"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-success"
                                    @onclick="@(async () => await ChangeMemberStatus(member))">
                                Status</button>
                            <button type="button" class="btn btn-sm btn-danger"
                                    @onclick="@(_ => OpenDeletePopup(member))">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }

    @if (_showCreatePopup)
    {
        <CreateMemberPopup OnClose="async () => await HandlePopupClose()"/>
    }

    @if (_showUpdatePopup)
    {
        <UpdateMemberPopup Member="_selectedMember" OnClose="async () => await HandlePopupClose()"/>
    }

    @if (_showDeletePopup)
    {
        <DeleteMemberPopup Member="_selectedMember" OnClose="async () => await HandlePopupClose()"/>
    }
</div>


@code {
    private List<MemberModel> _members = [];
    private bool _isLoading = true;
    private bool _isExporting;
    private bool _showCreatePopup;
    private bool _showDeletePopup;
    private bool _showUpdatePopup;

    private MemberModel _selectedMember = new();

    protected override async Task OnInitializedAsync() => await FetchData();

    private async Task FetchData()
    {
        _isLoading = true;
        try
        {
            _members = await MemberService.GetMembersAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to fetch members.");
            Toast.ShowError(ex.Message);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ChangeMemberStatus(MemberModel member)
    {
        try
        {
            await MemberService.UpdateMemberStatusAsync(member.Id);
            Toast.ShowSuccess("Member status updated.");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update memberStatus.");
            Toast.ShowError(ex.Message);
        }
        finally
        {
            await FetchData();
        }
    }

    private async Task ExportExcel()
    {
        try
        {
            Toast.ShowSInfo("Excel export started.");
            _isExporting = true;

            var workbook = new ClosedXML.Excel.XLWorkbook();
            var worksheet = workbook.Worksheets.Add("Members");

            worksheet.Cell(1, 1).Value = "Id";
            worksheet.Cell(1, 2).Value = "FirstName";
            worksheet.Cell(1, 3).Value = "LastName";
            worksheet.Cell(1, 4).Value = "Birthdate";
            worksheet.Cell(1, 5).Value = "Email";
            worksheet.Cell(1, 6).Value = "Telephone";
            worksheet.Cell(1, 7).Value = "Street";
            worksheet.Cell(1, 8).Value = "Number";
            worksheet.Cell(1, 9).Value = "ZipCode";
            worksheet.Cell(1, 10).Value = "City";
            worksheet.Cell(1, 11).Value = "Status";
            worksheet.Cell(1, 12).Value = "MembershipFee";
            worksheet.Cell(1, 13).Value = "Departments";

            for (var i = 0; i < _members.Count; i++)
            {
                var member = _members[i];
                var departments = string.Join(", ", member.Departments.Select(d => d.Name));
                
                worksheet.Cell(i + 2, 1).Value = member.Id.ToString();
                worksheet.Cell(i + 2, 2).Value = member.FirstName;
                worksheet.Cell(i + 2, 3).Value = member.LastName;
                worksheet.Cell(i + 2, 4).Value = member.Birthdate.ToString();
                worksheet.Cell(i + 2, 5).Value = member.Email;
                worksheet.Cell(i + 2, 6).Value = member.Telephone;
                worksheet.Cell(i + 2, 7).Value = member.Street;
                worksheet.Cell(i + 2, 8).Value = member.Number;
                worksheet.Cell(i + 2, 9).Value = member.ZipCode;
                worksheet.Cell(i + 2, 10).Value = member.City;
                worksheet.Cell(i + 2, 11).Value = member.Status;
                worksheet.Cell(i + 2, 12).Value = member.MembershipFee;
                worksheet.Cell(i + 2, 13).Value = departments;
            }

            var stream = new MemoryStream();
            workbook.SaveAs(stream);
            stream.Seek(0, SeekOrigin.Begin);

            var fileName = $"Members_{DateTime.Now}.xlsx";

            await BlazorDownloadFileService.DownloadFile(fileName, stream.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            _isExporting = false;
            Toast.ShowSuccess("Excel sheet was exported.");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to export excel sheet.");
            Toast.ShowError(ex.Message);
        }
    }

    private async Task HandlePopupClose()
    {
        _showCreatePopup = false;
        _showUpdatePopup = false;
        _showDeletePopup = false;
        _selectedMember = new MemberModel();
        await FetchData();
    }

    private void OpenUpdatePopup(MemberModel member)
    {
        _selectedMember = member;
        _showUpdatePopup = true;
    }

    private void OpenDeletePopup(MemberModel member)
    {
        _selectedMember = member;
        _showDeletePopup = true;
    }

    private static string GetStatusColor(string status) => status switch
    {
        "active" => "success",
        "inactive" => "secondary",
        _ => "dark"
    };

}
